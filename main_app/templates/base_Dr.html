<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}داشبورد پزشک{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <style>
    .errorlist { font-weight: 700; color: #dc2626; }
    .sidebar { width: 16rem; }
    .nav-link { display:flex; align-items:center; gap:.5rem; padding:.625rem .75rem; border-radius:.5rem; color:#e5e7eb; }
    .nav-link:hover { background-color:#2563eb; color:#fff; }
    .nav-active { background-color:#1d4ed8; color:#fff; }
    .badge { position:absolute; inset-inline-start:-.5rem; inset-block-start:-.5rem; background:#ef4444; color:#fff; border-radius:9999px; font-size:.75rem; padding:.125rem .375rem; }
    .card { background:#fff; border-radius:.75rem; box-shadow:0 10px 25px rgba(0,0,0,.05); }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-blue-700 text-white p-4 space-y-4 hidden md:block">
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-xl">پنل پزشک</div>
      </div>
      <nav class="space-y-1">
        <a href="{% url 'doctor_dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'doctor_dashboard' %}nav-active{% endif %}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12l2-2 4 4 8-8 2 2-10 10z"/></svg>
          خانه
        </a>
        <a href="{% url 'patient_list' %}" class="nav-link {% if request.resolver_match.url_name == 'patient_list' %}nav-active{% endif %}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0C9.66 11 11 9.66 11 8S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.67 0-8 1.34-8 4v2h10v-2c0-2.66-5.33-4-8-4zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.95 1.97 3.45v2h10v-2c0-2.66-5.33-4-8-4z"/></svg>
          بیماران
        </a>
        <a href="{% url 'nurse_list' %}" class="nav-link {% if request.resolver_match.url_name == 'nurse_list' %}nav-active{% endif %}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l4 4-4 4-4-4 4-4zm0 8c2.21 0 4 1.79 4 4v6H8v-6c0-2.21 1.79-4 4-4z"/></svg>
          پرستاران
        </a>
      </nav>
      <div class="pt-4 border-t border-blue-600">
        <a href="{% url 'logout' %}" class="nav-link">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13v-2H7V8l-5 4 5 4v-3h9zM20 3H10v2h10v14H10v2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
          خروج
        </a>
      </div>
    </aside>

    <!-- Main -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="bg-white shadow px-4 md:px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="sidebarToggle" class="md:hidden p-2 rounded hover:bg-gray-100" aria-label="toggle sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 5h14M3 10h14M3 15h14"/></svg>
          </button>
          <span class="font-bold text-lg">داشبورد پزشک</span>
        </div>

        <div class="flex items-center gap-4">
          <!-- Notifications -->
          <div class="relative">
            <button id="notifBtn" class="relative p-2 rounded hover:bg-gray-100" aria-haspopup="true" aria-expanded="false">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405C18.552 14.614 18 13.11 18 11.5V7a6 6 0 10-12 0v4.5c0 1.61-.552 3.114-1.595 4.095L3 17h5m7 0a2 2 0 11-4 0m4 0H8"/>
              </svg>
              {% if emergency_patients %}
                <span class="badge">{{ emergency_patients|length }}</span>
              {% endif %}
            </button>
            <div id="notifMenu" class="hidden absolute left-0 mt-2 w-72 card z-50">
              <div class="p-3 border-b">
                <div class="font-semibold">بیماران اورژانسی</div>
              </div>
              <ul class="max-h-64 overflow-auto">
                {% for patient in emergency_patients %}
                <li class="flex items-center justify-between px-3 py-2 border-b">
                  <span class="text-red-600">{{ patient.first_name }} {{ patient.last_name }}</span>
                  <div class="flex items-center gap-2">
                    <a href="{% url 'patient_detail' patient.pk %}" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">نمایش</a>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="dismiss_patient_alert" value="{{ patient.id }}"/>
                      <button type="submit" class="text-sm bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">متوجه شدم</button>
                    </form>
                  </div>
                </li>
                {% empty %}
                <li class="px-3 py-2 text-gray-500">بیمار اورژانسی وجود ندارد</li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <!-- User menu -->
          <div class="relative">
            <button id="userBtn" class="p-2 rounded hover:bg-gray-100 flex items-center gap-2" aria-haspopup="true" aria-expanded="false">
              <span>دکتر {{ doctor.first_name }} {{ doctor.last_name }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-700" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 011.414 0L10 12.586l3.293-2.879a1 1 0 011.414 1.414L10 15.414l-4.707-4.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
            <div id="userMenu" class="hidden absolute left-0 mt-2 w-48 card z-50">
              <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">خروج</a>
            </div>
          </div>
        </div>
      </header>

      <!-- Alerts (if provided) -->
      {% if alerts %}
      <section class="px-4 md:px-6 pt-4">
        {% for alert in alerts %}
          <div class="rounded-lg border border-yellow-200 bg-yellow-50 px-4 py-3 text-yellow-800 mb-2 flex items-center justify-between">
            <span>{{ alert }}</span>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="dismiss_alert" value="{{ alert }}"/>
              <button type="submit" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">متوجه شدم</button>
            </form>
          </div>
        {% endfor %}
      </section>
      {% endif %}

      <!-- Content -->
      <main class="flex-1 px-4 md:px-6 py-6">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <script>
    // Sidebar toggle (mobile)
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    if (sidebarToggle && sidebar) {
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
      });
    }

    // Menus
    function toggleMenu(btn, menu) {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', (!expanded).toString());
      menu.classList.toggle('hidden', expanded);
    }

    const notifBtn = document.getElementById('notifBtn');
    const notifMenu = document.getElementById('notifMenu');
    const userBtn = document.getElementById('userBtn');
    const userMenu = document.getElementById('userMenu');

    if (notifBtn && notifMenu) {
      notifBtn.addEventListener('click', () => toggleMenu(notifBtn, notifMenu));
    }
    if (userBtn && userMenu) {
      userBtn.addEventListener('click', () => toggleMenu(userBtn, userMenu));
    }

    // Click outside to close
    document.addEventListener('click', (e) => {
      const targets = [
        { btn: notifBtn, menu: notifMenu },
        { btn: userBtn, menu: userMenu },
      ];
      targets.forEach(({ btn, menu }) => {
        if (!btn || !menu) return;
        const clickInside = btn.contains(e.target) || menu.contains(e.target);
        if (!clickInside) {
          btn.setAttribute('aria-expanded', 'false');
          menu.classList.add('hidden');
        }
      });
    });

    // ESC to close menus
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        [notifMenu, userMenu].forEach(menu => menu && menu.classList.add('hidden'));
        [notifBtn, userBtn].forEach(btn => btn && btn.setAttribute('aria-expanded', 'false'));
      }
    });
  </script>
</body>
</html>
